#!/usr/bin/env python3

import argparse
import random
from datetime import datetime
from os import SEEK_END

from http_log_monitor.simulator import LogGenerator

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--output", type=str, default="/tmp/access.log", help="Log file to create"
    )
    parser.add_argument(
        "--wait_between",
        type=int,
        default=100,
        help="Seconds between the next fake log entry",
    )

    args = parser.parse_args()
    file = open(args.output, "a")

    # move the current position at the end of the file(seek(0,2))
    file.seek(0, SEEK_END)

    log_generator = LogGenerator()

    try:
        last_ts = datetime.now()
        log_entry = log_generator.generate_log_entry()
        file.write(log_entry)
        file.flush()
        while True:
            current_ts = datetime.now()
            diff = (current_ts - last_ts).total_seconds() * 1000  # miliseconds
            if diff >= args.wait_between:
                log_entry = log_generator.generate_log_entry()
                file.write(log_entry)
                file.flush()
                last_ts = datetime.now()
    except KeyboardInterrupt:
        file.close()
