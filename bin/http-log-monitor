#!/usr/bin/env python3
import os
import sys
import argparse
import time
from queue import Queue


from http_log_monitor.reader import Reader
from http_log_monitor.monitoring.stats import StatsMonitor
from http_log_monitor.monitoring.alert import AlertMonitor
from http_log_monitor.displays.cli import Cli

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--file", type=str, default="access.log")
    parser.add_argument("--interval", type=int, default=5)
    parser.add_argument("--alert_trigger", type=int, default=50)
    parser.add_argument("--alert_time_window", type=int, default=10)
    # TODO: Create a display flag (cli by default)

    args = parser.parse_args()

    try:
        if not os.path.isfile(args.file):
            raise FileNotFoundError

        # display
        cli_display = Cli()
        cli_display.start()

        # reader
        shared_queue = Queue()
        alert_queue = Queue()
        reader = Reader(
            file_path=args.file, queue=shared_queue, alert_queue=alert_queue
        )
        reader.start()

        # monitoring
        stats = StatsMonitor(
            queue=shared_queue,
            display=cli_display,
            interval=args.interval,
            log_path=args.file,
        )
        stats.start()

        alertMonitor = AlertMonitor(
            alert_queue=alert_queue,
            display=cli_display,
            trigger=args.alert_trigger,
            time_window=args.alert_time_window,
        )
        alertMonitor.start()

        while True:
            time.sleep(10)

    except FileNotFoundError:
        print(f"File not found {args.file}")
    except KeyboardInterrupt:
        print("...Stoping service")
        sys.exit(0)
