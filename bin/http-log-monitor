#!/usr/bin/env python3
import argparse
import os
import sys
import time
from queue import Queue

from http_log_monitor.displays.cli import Cli
from http_log_monitor.monitoring.alert import AlertMonitor
from http_log_monitor.monitoring.stats import StatsMonitor
from http_log_monitor.reader import Reader

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--file", type=str, default="access.log", help="file to monitoring")
    parser.add_argument("--interval", type=int, default=5, help="interval where statistics are updated")
    parser.add_argument("--alert_trigger", type=int, default=50, help="requests trigger to show an alert for high traffic")
    parser.add_argument("--alert_time_window", type=int, default=10, help="time windows to monitor the alarms")

    args = parser.parse_args()

    try:
        if not os.path.isfile(args.file):
            raise FileNotFoundError

        # display
        cli_display = Cli()
        cli_display.start()

        # reader
        shared_queue = Queue()
        alert_queue = Queue()
        reader = Reader(
            file_path=args.file, queue=shared_queue, alert_queue=alert_queue
        )
        reader.start()

        # monitoring
        stats = StatsMonitor(
            queue=shared_queue,
            display=cli_display,
            interval=args.interval,
            log_path=args.file,
        )
        stats.start()

        alertMonitor = AlertMonitor(
            alert_queue=alert_queue,
            display=cli_display,
            trigger=args.alert_trigger,
            time_window=args.alert_time_window,
        )
        alertMonitor.start()

        while True:
            time.sleep(10)

    except FileNotFoundError:
        print(f"File not found {args.file}")
    except KeyboardInterrupt:
        print("...Stoping the http log monitor")
        sys.exit(0)
